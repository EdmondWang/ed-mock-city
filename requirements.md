# Ed-Mock-City 项目需求文档

## 项目概述

**Ed-Mock-City** 是一个基于 Web 技术的城市建设模拟游戏，灵感来源于《城市：天际线》（Cities: Skylines）。项目旨在提供一个轻量级、易上手的城市建设体验，使用现代前端技术栈（TypeScript + Pixi.js）实现。

## 游戏核心愿景

创建一个可扩展的城市建设模拟框架，玩家可以通过规划、建造和管理来发展自己的虚拟城市，体验从零开始建设大都市的成就感。

## 《城市：天际线》核心功能参考

### 1. **城市建设与规划**
- 网格化地形和区域划分
- 道路网络建设（不同等级的道路）
- 分区系统（住宅区、商业区、工业区、办公区）
- 建筑放置与升级

### 2. **市民模拟系统**
- 市民 AI（住宅、工作、休闲、出行）
- 人口增长与年龄结构
- 市民需求系统（住房、就业、教育、医疗、娱乐）
- 交通出行模式（步行、驾车、公共交通）

### 3. **基础设施与服务**
- 水电供应系统（发电站、水塔、管道）
- 垃圾处理（垃圾场、回收中心）
- 公共服务（警察局、消防局、医院、学校）
- 公共交通（公交、地铁、火车）

### 4. **经济与资源管理**
- 城市预算（税收、支出、贷款）
- 资源供需平衡
- 产业发展链（原材料→加工→商品）
- 进出口贸易

### 5. **环境与可持续发展**
- 污染管理（空气、水、噪音）
- 绿化与公园系统
- 可再生能源
- 垃圾回收与处理

### 6. **政策与治理**
- 法律法规制定
- 税收政策调整
- 公共服务优先级
- 城市建设条例

## 当前项目基础分析

### 现有技术栈
- **渲染引擎**: Pixi.js v8.14.3
- **编程语言**: TypeScript 5.9.3
- **构建工具**: Vite 6.4.1
- **包管理器**: pnpm
- **项目状态**: 基础框架已搭建，包含游戏循环、场景管理和玩家控制

### 现有代码结构
```
src/
├── game/Game.ts          # 游戏主控制器
├── scenes/MainScene.ts   # 主游戏场景
├── sprites/Player.ts     # 玩家精灵类
├── main.ts              # 应用入口
└── style.css            # 样式文件
```

### 优势与不足
- **优势**: 清晰的模块化架构、现代化的技术栈、Pixi.js 性能优秀
- **不足**: 缺少城市建设模拟的核心机制、需要重构成网格化系统

## 第一阶段需求：基础市民与住宅系统

### 1. **核心目标**
实现一个简化的城市建设模拟，玩家可以建造住宅楼，市民以固定速度生成并入住，体验基础的城市人口增长机制。

### 2. **功能需求**

#### 2.1 网格化地图系统
- 创建固定大小的网格地图（如 20x20 网格）
- 每个网格单元可放置建筑物
- 网格可视化（显示单元格边框）
- 网格坐标与像素坐标转换系统

#### 2.2 住宅建筑系统
- 住宅建筑类型（初期可用 1-2 种）
- 建筑属性：容量（可容纳市民数）、建造成本、维护费用
- 建筑放置机制：点击空网格放置建筑
- 建筑状态：空闲、部分入住、满员
- 建筑可视化：不同样式的住宅楼图形

#### 2.3 市民模拟系统
- 市民以固定速率生成（如每 10 秒生成 1 位市民）
- 市民属性：ID、状态（无家可归、已入住）、住宅位置
- 市民分配逻辑：将无家可归市民分配到有空位的住宅
- 市民容量管理：住宅满员后不再接受新市民
- 市民总数统计与显示

#### 2.4 用户界面
- 游戏主界面显示：
  - 当前市民总数
  - 无家可归市民数量
  - 住宅总数及占用率
  - 可用资金（简化版经济系统）
- 建筑菜单：显示可建造的建筑类型及成本
- 网格悬停提示：显示当前位置信息
- 建筑信息面板：点击建筑显示详情（入住率、容量等）

#### 2.5 游戏状态管理
- 游戏时间系统（简化版，按固定速率推进）
- 市民生成计时器
- 建筑管理数据结构
- 市民分配队列

### 3. **技术实现需求**

#### 3.1 新增类结构
```
src/
├── core/
│   ├── GridSystem.ts     # 网格系统管理
│   └── GameState.ts      # 游戏状态管理
├── buildings/
│   ├── Building.ts       # 建筑基类
│   └── ResidentialBuilding.ts  # 住宅建筑类
├── citizens/
│   └── Citizen.ts        # 市民类
├── ui/
│   ├── GameUI.ts         # 游戏主界面
│   └── BuildingMenu.ts   # 建筑菜单
└── scenes/
    └── CityScene.ts      # 城市建设场景（替换MainScene）
```

#### 3.2 关键数据结构
```typescript
// 网格单元
interface GridCell {
  x: number;
  y: number;
  occupied: boolean;
  building: Building | null;
}

// 建筑基础属性
interface BuildingData {
  id: string;
  type: 'residential' | 'commercial' | 'industrial';
  capacity: number;
  cost: number;
  maintenance: number;
  occupants: Citizen[];
}

// 市民数据
interface CitizenData {
  id: string;
  name?: string;
  status: 'homeless' | 'homed';
  homeId?: string;
  satisfaction: number; // 满意度（未来扩展）
}
```

#### 3.3 核心算法
- 市民生成算法：基于时间间隔生成新市民
- 市民分配算法：将无家可归市民分配到最近的有空位住宅
- 网格碰撞检测：防止建筑重叠放置
- 路径查找算法（基础版，为未来交通系统做准备）

### 4. **UI/UX设计需求**

#### 4.1 游戏主界面布局
```
+-----------------------------------+
| 游戏标题 | 市民: 120 | 住宅: 15/20 |
|-----------------------------------|
| 建筑菜单                          |
| [住宅楼] [商业楼] [道路]          |
|                                   |
|          游戏地图区域             |
|          (网格化地图)             |
|                                   |
+-----------------------------------+
```

#### 4.2 交互设计
- 左键点击空网格：打开建筑菜单
- 右键点击建筑：显示建筑信息
- 鼠标悬停网格：高亮显示并提示信息
- 快捷键支持：数字键快速选择建筑类型

#### 4.3 视觉反馈
- 建筑放置预览（半透明轮廓）
- 市民入住动画（简单的移动效果）
- 状态变化提示（数字变化、图标闪烁）
- 错误提示（放置位置无效、资金不足）

### 5. **性能要求**
- 支持至少 1000 个市民同时模拟
- 60 FPS 稳定渲染
- 网格地图至少支持 50x50 大小
- 内存使用优化，避免内存泄漏

### 6. **扩展性考虑**
- 模块化设计，便于添加新建筑类型
- 事件驱动架构，便于添加新游戏机制
- 数据与渲染分离，便于未来添加网络功能
- 配置外部化，便于游戏平衡调整

## 技术架构设计

### 1. **架构模式**
采用 **组件-实体-系统（CES）** 的变体模式，适应 Pixi.js 的渲染特性：
- **实体**：游戏对象（建筑、市民）
- **组件**：对象属性（位置、状态、渲染）
- **系统**：游戏逻辑（市民生成、分配、渲染）

### 2. **渲染优化策略**
- 使用 Pixi.js 的批处理渲染
- 静态元素（网格、背景）单独图层
- 动态元素（市民、特效）优化更新频率
- 视口裁剪，只渲染可见区域

### 3. **状态管理**
- 集中式游戏状态管理
- 不可变数据更新模式
- 状态变化事件通知系统
- 游戏状态序列化（为未来保存功能准备）

## 开发里程碑

### 里程碑 1：基础框架重构（预计 2-3 天）
- 创建网格系统基础类
- 重构场景系统，创建 CityScene
- 建立游戏状态管理机制
- 实现基础 UI 框架

### 里程碑 2：建筑系统实现（预计 3-4 天）
- 实现 Building 基类和 ResidentialBuilding
- 完成建筑放置逻辑
- 实现网格碰撞检测
- 添加建筑信息显示

### 里程碑 3：市民系统实现（预计 3-4 天）
- 创建 Citizen 类和管理系统
- 实现市民生成定时器
- 开发市民分配算法
- 添加市民统计显示

### 里程碑 4：UI 完善与优化（预计 2-3 天）
- 完善游戏主界面
- 添加建筑菜单系统
- 优化用户交互体验
- 添加视觉反馈效果

### 里程碑 5：测试与优化（预计 2-3 天）
- 性能测试与优化
- 游戏平衡调整
- Bug 修复
- 文档编写

## 风险与缓解措施

### 技术风险
1. **性能问题**：大量市民模拟可能导致性能下降
   - 缓解：实施 LOD（细节层次）系统，优化渲染批次

2. **代码复杂度**：模拟逻辑可能变得复杂难维护
   - 缓解：严格遵循模块化设计，编写单元测试

3. **Pixi.js 学习曲线**：团队成员可能需要时间熟悉 Pixi.js
   - 缓解：创建 Pixi.js 最佳实践文档，复用现有代码

### 项目风险
1. **范围蔓延**：不断添加新功能导致项目失控
   - 缓解：严格按阶段开发，完成第一阶段后再评估下一阶段

2. **时间估计不准确**：模拟游戏开发时间难以精确估计
   - 缓解：采用敏捷开发，每两周评估进度

## 成功标准

### 第一阶段成功标准
1. 玩家可以在地图上放置住宅建筑
2. 市民以固定速率生成并自动入住空闲住宅
3. 游戏稳定运行，无严重性能问题
4. UI 清晰显示关键游戏信息
5. 代码结构清晰，便于后续扩展

### 长期成功标准
1. 实现完整的经济系统（税收、支出、预算）
2. 添加多种建筑类型（商业、工业、公共设施）
3. 实现市民需求系统（就业、教育、娱乐）
4. 添加交通系统和市民出行模拟
5. 支持游戏保存和加载功能

## 下一步行动

1. **确认需求**：与项目干系人确认第一阶段需求范围
2. **技术选型确认**：确保 Pixi.js v8.14.3 满足所有技术要求
3. **开发环境准备**：设置开发、测试、生产环境
4. **团队分工**：根据里程碑分配开发任务
5. **开始开发**：按里程碑顺序开始实施

---

*文档版本：1.0*
*创建日期：2026-01-17*
*最后更新：2026-01-17*